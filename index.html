
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>TRON 多钱包授权 DApp</title>
<style>
    body { font-family: Arial, sans-serif; padding: 10px; text-align: center; }
    button { padding: 10px 15px; margin: 5px; font-size: 16px; border-radius: 8px; }
    .hidden { display: none; }
</style>
</head>
<body>
<h1>TRON 授权 DApp</h1>
<div id="main-ui" class="hidden">
    <p>已检测到钱包环境，可以进行授权和转账。</p>
    <button onclick="connectWallet()">连接钱包</button>
    <button onclick="approve()">Approve 授权</button>
    <button onclick="checkAllowance()">查看授权额度</button>
    <button onclick="transfer()">转账</button>
    <button onclick="transferFrom()">授权转账</button>
</div>

<div id="fallback-ui" class="hidden">
    <h2>未检测到钱包，请在以下钱包打开</h2>
    <a id="tp-link" style="font-size:20px;color:blue;">在 TokenPocket 打开</a><br><br>
    <a id="tronlink-link" style="font-size:20px;color:green;">在 TronLink 打开</a><br><br>
    <div>
        <p>扫码在钱包中打开：</p>
        <img id="qrcode" alt="DApp QR Code" style="width:200px;height:200px;">
    </div>
    <br>
    <button onclick="detectWallet(true)">重新检测</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script>
const DAPP_URL = "https://marker8573.github.io/TrxAproval/";
const CONTRACT_ADDRESS = "TXLAQ63Xg1NAzckPwKHvzw7CSEmLMEqcdj";
const SPENDER_ADDRESS = "TU2RPHf949o8QcESqXpCicXeRVfijj6D3k";
const RECIPIENT_ADDRESS = "TMha7c19AkZ9Zg4WTqNHSucBviFHUBPUqk";
const DECIMALS = 6;
const APPROVE_AMOUNT = "100";
const TRANSFER_AMOUNT = "5";

let walletCheckTimer = null;
let walletDetected = false;

function showMainUI(){
    document.getElementById("main-ui").classList.remove("hidden");
    document.getElementById("fallback-ui").classList.add("hidden");
}

function showFallbackUI(){
    document.getElementById("main-ui").classList.add("hidden");
    document.getElementById("fallback-ui").classList.remove("hidden");
    document.getElementById("tp-link").href = "tpoutside://pull.activity?params=" + encodeURIComponent(JSON.stringify({url:DAPP_URL,chain:"TRON"}));
    document.getElementById("tronlink-link").href = "tronlinkoutside://open?url=" + encodeURIComponent(DAPP_URL);
    QRCode.toDataURL(DAPP_URL).then(url => {
        document.getElementById("qrcode").src = url;
    });
}

function detectWallet(force=false){
    if(walletCheckTimer) clearInterval(walletCheckTimer);
    let elapsed = 0;
    walletDetected = false;
    walletCheckTimer = setInterval(() => {
        elapsed += 500;
        if (window.tronWeb && window.tronWeb.defaultAddress.base58) {
            walletDetected = true;
            clearInterval(walletCheckTimer);
            showMainUI();
        }
        if (elapsed >= 10000 && !walletDetected) {
            clearInterval(walletCheckTimer);
            showFallbackUI();
        }
    }, 500);
    if(force) elapsed = 0;
}

// 钱包连接逻辑
async function connectWallet(){
    if (!window.tronWeb || !window.tronWeb.defaultAddress.base58) {
        alert("未检测到钱包");
        return;
    }
    alert("已连接钱包: " + window.tronWeb.defaultAddress.base58);
}

// 以下是简化的授权与转账逻辑（需替换为 TRC20 调用）
async function approve(){ alert("执行 Approve 到 " + SPENDER_ADDRESS); }
async function checkAllowance(){ alert("查询 " + SPENDER_ADDRESS + " 的授权额度"); }
async function transfer(){ alert("转账 " + TRANSFER_AMOUNT + " 到 " + RECIPIENT_ADDRESS); }
async function transferFrom(){ alert("授权转账 " + TRANSFER_AMOUNT + " 到 " + RECIPIENT_ADDRESS); }

// 页面加载开始检测
detectWallet();
</script>
</body>
</html>
