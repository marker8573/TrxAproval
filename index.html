<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TRON 多钱包授权 DApp</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; background: #f8f9fa; }
button { padding: 10px 15px; margin: 5px; font-size: 16px; cursor: pointer; }
#status { margin-top: 20px; padding: 10px; background: white; border-radius: 6px; min-height: 40px; }
.success { color: green; }
.error { color: red; white-space: pre-wrap; }
a { color: blue; text-decoration: underline; }
</style>
</head>
<body>
<h2>TRON 多钱包授权 DApp</h2>
<p>支持 TronLink, TokenPocket, imToken, TrustWallet</p>
<button onclick="connectWallet()">连接钱包</button>
<button onclick="approve()">授权</button>
<button onclick="transferFrom()">转账(使用授权)</button>
<div id="status"></div>

<script>
const tokenAddress = "TXLAQ63Xg1NAzckPwKHvzw7CSEmLMEqcdj";
const spenderAddress = "TU2RPHf949o8QcESqXpCicXeRVfijj6D3k";
const amount = "1000"; // 授权金额，按代币精度设置

function logStatus(msg, type="") {
    const el = document.getElementById("status");
    el.innerHTML = msg;
    el.className = type;
}

async function connectWallet() {
    if (!window.tronWeb) {
        logStatus("未检测到 Tron 钱包，请在 TronLink/TP/imToken DApp 浏览器打开", "error");
        return;
    }
    try {
        if (window.tronWeb.request) {
            await window.tronWeb.request({ method: 'tron_requestAccounts' });
        }
        const addr = window.tronWeb.defaultAddress.base58;
        logStatus("已连接钱包: " + addr, "success");
    } catch (e) {
        logStatus("连接钱包失败: " + e.message, "error");
    }
}

function approve() {
    if (!window.tronWeb) return logStatus("钱包未连接", "error");

    const handleError = (err) => logStatus("授权失败: " + (err && err.message ? err.message : JSON.stringify(err)), "error");
    const handleSuccess = (txHash) => {
        const url = `https://nile.tronscan.org/#/transaction/${txHash}`;
        logStatus(`授权成功! <a href="${url}" target="_blank">${txHash}</a>`, "success");
    };

    window.tronWeb.contract().at(tokenAddress, function(err, contract) {
        if (err) return handleError(err);
        try {
            // 回调模式，兼容 imToken
            contract.approve(spenderAddress, amount).send({}, function(err, txHash) {
                if (err) return handleError(err);
                handleSuccess(txHash);
            });
        } catch (e) {
            handleError(e);
        }
    });
}

function transferFrom() {
    if (!window.tronWeb) return logStatus("钱包未连接", "error");

    const from = "替换成授权人的地址";
    const to = "替换成接收人的地址";

    const handleError = (err) => logStatus("转账失败: " + (err && err.message ? err.message : JSON.stringify(err)), "error");
    const handleSuccess = (txHash) => {
        const url = `https://nile.tronscan.org/#/transaction/${txHash}`;
        logStatus(`转账成功! <a href="${url}" target="_blank">${txHash}</a>`, "success");
    };

    window.tronWeb.contract().at(tokenAddress, function(err, contract) {
        if (err) return handleError(err);
        try {
            contract.transferFrom(from, to, amount).send({}, function(err, txHash) {
                if (err) return handleError(err);
                handleSuccess(txHash);
            });
        } catch (e) {
            handleError(e);
        }
    });
}
</script>
</body>
</html>
